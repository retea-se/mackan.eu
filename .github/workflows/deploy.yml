name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # TillÃ¥ter manuell kÃ¶rning frÃ¥n GitHub UI

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          echo "ğŸ“¦ Fetching latest changes from main..."
          git fetch origin main
          
          # Try to pull, and if it fails due to untracked files, handle it
          echo "ğŸ“¥ Pulling latest changes from main..."
          if ! git pull origin main 2>&1 | tee /tmp/git-pull.log; then
            echo "âš ï¸  Git pull failed. Checking error..."
            # Check if error is about untracked files that would be overwritten
            if grep -q "would be overwritten by merge" /tmp/git-pull.log; then
              echo "ğŸ—‘ï¸  Removing conflicting untracked files..."
              # Extract filenames - they appear after "would be overwritten by merge:" and before "Please"
              grep -A 100 "would be overwritten by merge" /tmp/git-pull.log | \
                grep -v "would be overwritten\|Please move\|Aborting" | \
                sed 's/^[[:space:]]*//' | \
                grep -v '^$' | \
                while read file; do
                  if [ -n "$file" ] && [ -f "$file" ]; then
                    echo "  Removing: $file"
                    rm -f "$file"
                  fi
                done
              echo "ğŸ”„ Retrying git pull..."
              git pull origin main
            else
              echo "âŒ Git pull failed with different error. Attempting hard reset..."
              git reset --hard origin/main
            fi
          fi
          
          echo "âœ… Deployment complete!"

          # Eventuellt: Rensa cache, restart services, etc.
          # php artisan cache:clear  # Om du anvÃ¤nder Laravel
          # systemctl reload php-fpm  # Om du anvÃ¤nder systemd

    - name: ğŸ“Š Deployment status
      if: always()
      run: |
        echo "Deployment job completed with status: ${{ job.status }}"

