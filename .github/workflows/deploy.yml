name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # TillÃ¥ter manuell kÃ¶rning frÃ¥n GitHub UI

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        debug: true
        script: |
          # Use absolute path - expand ~ if present
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${DEPLOY_PATH#~}" != "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
          fi

          echo "ğŸ“ Deploy path: $DEPLOY_PATH"
          echo "ğŸ“‚ Home directory: $HOME"
          echo "ğŸ“‚ Current directory: $(pwd)"

          # Change to deploy directory
          if ! cd "$DEPLOY_PATH"; then
            echo "âŒ Failed to cd to $DEPLOY_PATH"
            echo "ğŸ“‚ Current directory: $(pwd)"
            ls -la "$(dirname "$DEPLOY_PATH")" || true
            exit 1
          fi

          echo "ğŸ“‚ Changed to: $(pwd)"
          echo "ğŸ“¦ Fetching latest changes from main..."
          git fetch origin main || {
            echo "âŒ Git fetch failed"
            exit 1
          }

          echo "ğŸ“¥ Pulling latest changes from main..."
          if ! git pull origin main; then
            echo "âš ï¸  Git pull failed. Using hard reset to match remote..."
            git reset --hard origin/main || {
              echo "âŒ Git reset failed"
              exit 1
            }
          fi

          echo "âœ… Deployment complete!"
          echo "ğŸ“Š Current commit: $(git rev-parse --short HEAD)"
          echo "ğŸ“Š Current branch: $(git branch --show-current)"

          # Eventuellt: Rensa cache, restart services, etc.
          # php artisan cache:clear  # Om du anvÃ¤nder Laravel
          # systemctl reload php-fpm  # Om du anvÃ¤nder systemd

    - name: ğŸ“Š Deployment status
      if: always()
      run: |
        echo "Deployment job completed with status: ${{ job.status }}"

