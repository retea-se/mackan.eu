name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # TillÃ¥ter manuell kÃ¶rning frÃ¥n GitHub UI

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          echo "ğŸ“ Deploy path: $DEPLOY_PATH"
          
          # Expand ~ to home directory if needed
          if [[ "$DEPLOY_PATH" == ~* ]]; then
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
          fi
          
          echo "ğŸ“ Expanded path: $DEPLOY_PATH"
          cd "$DEPLOY_PATH" || {
            echo "âŒ Failed to cd to $DEPLOY_PATH"
            echo "ğŸ“‚ Current directory: $(pwd)"
            echo "ğŸ“‚ Home directory: $HOME"
            exit 1
          }
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“¦ Fetching latest changes from main..."
          git fetch origin main
          
          echo "ğŸ“¥ Pulling latest changes from main..."
          # Try to pull, if it fails due to conflicts, use reset --hard
          if ! git pull origin main 2>&1; then
            echo "âš ï¸  Git pull failed. Using hard reset to match remote..."
            git reset --hard origin/main
          fi
          
          echo "âœ… Deployment complete!"
          echo "ğŸ“Š Current commit: $(git rev-parse --short HEAD)"
          echo "ğŸ“Š Current branch: $(git branch --show-current)"

          # Eventuellt: Rensa cache, restart services, etc.
          # php artisan cache:clear  # Om du anvÃ¤nder Laravel
          # systemctl reload php-fpm  # Om du anvÃ¤nder systemd

    - name: ğŸ“Š Deployment status
      if: always()
      run: |
        echo "Deployment job completed with status: ${{ job.status }}"

