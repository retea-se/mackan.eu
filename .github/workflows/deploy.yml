name: üöÄ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Till√•ter manuell k√∂rning fr√•n GitHub UI

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîê Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          echo "üì¶ Fetching latest changes from main..."
          git fetch origin main
          
          # Try to pull, and if it fails due to untracked files, handle it
          echo "üì• Pulling latest changes from main..."
          GIT_PULL_OUTPUT=$(git pull origin main 2>&1) || {
            PULL_EXIT_CODE=$?
            echo "$GIT_PULL_OUTPUT"
            # Check if error is about untracked files that would be overwritten
            if echo "$GIT_PULL_OUTPUT" | grep -q "would be overwritten by merge"; then
              echo "‚ö†Ô∏è  Git pull failed due to untracked files. Removing conflicting files..."
              # Extract filenames from error message (lines between "would be overwritten" and "Please")
              echo "$GIT_PULL_OUTPUT" | \
                sed -n '/would be overwritten by merge:/,/Please move or remove them/p' | \
                grep -v "would be overwritten\|Please move\|Aborting" | \
                sed 's/^[[:space:]]*//' | \
                xargs -r rm -f
              echo "üîÑ Retrying git pull..."
              git pull origin main
            else
              echo "‚ùå Git pull failed with different error. Attempting hard reset..."
              git reset --hard origin/main
            fi
          }
          
          echo "‚úÖ Deployment complete!"

          # Eventuellt: Rensa cache, restart services, etc.
          # php artisan cache:clear  # Om du anv√§nder Laravel
          # systemctl reload php-fpm  # Om du anv√§nder systemd

    - name: üìä Deployment status
      if: always()
      run: |
        echo "Deployment job completed with status: ${{ job.status }}"

