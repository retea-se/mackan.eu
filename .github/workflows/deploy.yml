name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # TillÃ¥ter manuell kÃ¶rning frÃ¥n GitHub UI

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          echo "ğŸ“¦ Fetching latest changes from main..."
          git fetch origin main
          
          echo "ğŸ“¥ Pulling latest changes from main..."
          # Try to pull, if it fails due to conflicts, use reset --hard
          git pull origin main 2>&1 || {
            echo "âš ï¸  Git pull failed. Using hard reset to match remote..."
            git reset --hard origin/main
          }
          
          echo "âœ… Deployment complete!"

          # Eventuellt: Rensa cache, restart services, etc.
          # php artisan cache:clear  # Om du anvÃ¤nder Laravel
          # systemctl reload php-fpm  # Om du anvÃ¤nder systemd

    - name: ğŸ“Š Deployment status
      if: always()
      run: |
        echo "Deployment job completed with status: ${{ job.status }}"

