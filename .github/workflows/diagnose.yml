name: ğŸ” Diagnose Deployment Issues

on:
  workflow_dispatch:  # KÃ¶r endast manuellt

jobs:
  diagnose:
    name: SSH Diagnostics
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Test 1 - Basic SSH Connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        debug: true
        script: |
          echo "âœ… SSH connection successful!"
          echo "ğŸ“‚ Home directory: $HOME"
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ‘¤ Current user: $(whoami)"

    - name: ğŸ” Test 2 - Check Deploy Path
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        debug: true
        script: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          echo "ğŸ” Original DEPLOY_PATH: $DEPLOY_PATH"

          # Expand ~ if present
          if [ "${DEPLOY_PATH#\~}" != "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
            echo "ğŸ” Expanded DEPLOY_PATH: $DEPLOY_PATH"
          fi

          echo "ğŸ“ Checking if path exists: $DEPLOY_PATH"
          if [ -d "$DEPLOY_PATH" ]; then
            echo "âœ… Deploy path exists!"
            ls -la "$DEPLOY_PATH"
          else
            echo "âŒ Deploy path does NOT exist!"
            echo "ğŸ“ Checking parent directory:"
            ls -la "$(dirname "$DEPLOY_PATH")" || echo "Parent directory also doesn't exist"
          fi

    - name: ğŸ” Test 3 - Check Git Repository
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        debug: true
        script: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${DEPLOY_PATH#\~}" != "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
          fi

          echo "ğŸ“ Changing to: $DEPLOY_PATH"
          cd "$DEPLOY_PATH" || exit 1

          echo "ğŸ” Checking Git repository:"
          if [ -d ".git" ]; then
            echo "âœ… .git directory exists!"
            echo "ğŸ“Š Git status:"
            git status
            echo "ğŸ“Š Git remote:"
            git remote -v
            echo "ğŸ“Š Current branch:"
            git branch --show-current
            echo "ğŸ“Š Git config:"
            git config --list | grep -E "(remote|branch)" || true
          else
            echo "âŒ Not a Git repository!"
          fi

    - name: ğŸ” Test 4 - Test Git Fetch
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        debug: true
        script: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${DEPLOY_PATH#\~}" != "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
          fi

          cd "$DEPLOY_PATH" || exit 1

          echo "ğŸ“¦ Testing git fetch..."
          if git fetch origin main; then
            echo "âœ… Git fetch succeeded!"
          else
            echo "âŒ Git fetch failed!"
            echo "ğŸ” Checking network connectivity:"
            ping -c 3 github.com || true
            echo "ğŸ” Testing HTTPS connection to GitHub:"
            curl -I https://github.com 2>&1 | head -5 || true
          fi

    - name: ğŸ” Test 5 - Test Git Pull
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        debug: true
        script: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ "${DEPLOY_PATH#\~}" != "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
          fi

          cd "$DEPLOY_PATH" || exit 1

          echo "ğŸ“¥ Testing git pull..."
          if git pull origin main; then
            echo "âœ… Git pull succeeded!"
            echo "ğŸ“Š Current commit: $(git rev-parse --short HEAD)"
          else
            echo "âŒ Git pull failed!"
            echo "âš ï¸  Error details above"
          fi

    - name: ğŸ“Š Summary
      if: always()
      run: |
        echo "ğŸ” Diagnostics complete!"
        echo "ğŸ“‹ Check the results of each test above to identify the issue."
        echo "ğŸ“– Common issues:"
        echo "  - SSH connection fails: Check SSH_HOST, SSH_USER, SSH_PRIVATE_KEY secrets"
        echo "  - Deploy path doesn't exist: Check DEPLOY_PATH secret"
        echo "  - Git repository missing: Initialize git repo on server"
        echo "  - Git fetch/pull fails: Check git remote configuration or network access"
